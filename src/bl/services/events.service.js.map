{"version":3,"file":"events.service.js","sourceRoot":"","sources":["events.service.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,4EAAyE;AAEzE,0EAAuE;AAIvE;IAAA;IA2CA,CAAC;IA1CgB,mCAAW,GAAxB,UAAyB,SAAiB,EAAE,QAAgB,EAAE,OAAe,EACpD,gBAAwB,EAAE,QAAwC,EAAE,YAA+B,EAAE,YAA2B;;;;;4BACrJ,qBAAM,IAAI,CAAC,kBAAkB,CAAC,SAAS,EAAE,QAAQ,CAAC,EAAA;;wBAAlD,SAAkD,CAAC;wBAC/C,gBAAgB,GAAG,IAAI,mCAAgB,EAAE,CAAC;wBAE1C,KAAK,GAAY;4BACjB,SAAS,EAAE,SAAS;4BACpB,QAAQ,EAAE,QAAQ;4BAClB,OAAO,EAAE,OAAO;4BAChB,gBAAgB,EAAE,gBAAgB;4BAClC,QAAQ,EAAE;gCACN,WAAW,EAAE;oCACT,GAAG,EAAE,QAAQ,IAAI,SAAS,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,QAAQ,CAAC,GAAG;oCAChD,IAAI,EAAE,QAAQ,IAAI,SAAS,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,QAAQ,CAAC,IAAI;iCACrD;gCACD,gBAAgB,EAAE,YAAY,IAAI,SAAS,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,YAAY,CAAC,WAAW;gCAC7E,iBAAiB,EAAE,YAAY,IAAI,SAAS,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,YAAY,CAAC,gBAAgB;gCACnF,eAAe,EAAE,YAAY,IAAI,SAAS,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,YAAY,CAAC,OAAO;gCACxE,OAAO,EAAE,YAAY,IAAI,SAAS,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,YAAY,CAAC,OAAO;6BACnE;4BACD,SAAS,EAAE,IAAI,IAAI,EAAE;4BACrB,YAAY,EAAE,YAAY,IAAI,SAAS,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,YAAY;yBAChE,CAAC;;;;wBAGE,qBAAM,gBAAgB,CAAC,IAAI,CAAC,KAAK,CAAC,EAAA;;wBAAlC,SAAkC,CAAC;;;;wBAEnC,OAAO,CAAC,GAAG,CAAC,qBAAqB,GAAG,GAAC,CAAC,CAAC;wBACvC,MAAM,GAAC,CAAC;;;;;KAEf;IAGa,0CAAkB,GAAhC,UAAiC,SAAiB,EAAE,QAAgB;;;;;;wBAC5D,eAAe,GAAG,IAAI,iCAAe,EAAE,CAAC;wBACf,qBAAM,eAAe,CAAC,sBAAsB,CAAC,SAAS,EAAE,QAAQ,CAAC,EAAA;;wBAA1F,sBAAsB,GAAG,SAAiE;wBAC9F,IAAI,CAAC,sBAAsB,EAAE;4BACrB,OAAO,GAAG,gDAAgD,GAAG,SAAS,GAAG,mBAAmB,GAAG,QAAQ,CAAC;4BAC5G,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;4BACrB,MAAM,IAAI,KAAK,CAAC,OAAO,CAAC,CAAC;yBAC5B;;;;;KACJ;IACL,oBAAC;AAAD,CAAC,AA3CD,IA2CC;AA3CY,sCAAa","sourcesContent":["import {EventsRepository} from \"../../dal/repositories/eventsRepository\";\r\nimport {EventDB} from \"../../dal/types/event\";\r\nimport {UsersRepository} from \"../../dal/repositories/usersRepository\";\r\nimport { MedicalStatsDB } from \"../../dal/types/medicalStats\";\r\nimport {GQLCoordinates, GQLWeather} from \"../../../graphql-types\";\r\n\r\nexport class EventsService {\r\n    public async addNewEvent(userEmail: string, appToken: string, logType: string,\r\n                             eventDescription: string, location?: { lat: number, long: number }, medicalStats?: MedicalStatsDB[], locationData?: LocationData) {\r\n        await this.validateUserAndApp(userEmail, appToken);\r\n        let eventsRepository = new EventsRepository();\r\n        // @ts-ignore\r\n        let event: EventDB = {\r\n            userEmail: userEmail,\r\n            appToken: appToken,\r\n            logType: logType,\r\n            eventDescription: eventDescription,\r\n            location: {\r\n                coordinates: {\r\n                    lat: location == undefined ? null : location.lat,\r\n                    long: location == undefined ? null : location.long\r\n                },\r\n                crowdednessLevel: locationData == undefined ? null : locationData.crowdedness,\r\n                pointsOfInterests: locationData == undefined ? null : locationData.pointsOfInterest,\r\n                geocodedAddress: locationData == undefined ? null : locationData.address,\r\n                weather: locationData == undefined ? null : locationData.weather\r\n            },\r\n            timestamp: new Date(),\r\n            medicalStats: medicalStats == undefined ? null : medicalStats\r\n        };\r\n\r\n        try {\r\n            await eventsRepository.save(event);\r\n        } catch (e) {\r\n            console.log(\"error saving event \" + e);\r\n            throw e;\r\n        }\r\n    }\r\n\r\n\r\n    private async validateUserAndApp(userEmail: string, appToken: string) {\r\n        let usersRepository = new UsersRepository();\r\n        let findByEmailAndAppToken = await usersRepository.findByEmailAndAppToken(userEmail, appToken);\r\n        if (!findByEmailAndAppToken) {\r\n            let message = \"trying to save event for an unidentified user \" + userEmail + \" under app token \" + appToken;\r\n            console.log(message);\r\n            throw new Error(message);\r\n        }\r\n    }\r\n}"]}